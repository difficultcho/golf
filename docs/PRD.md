# 项目需求文档（PRD）

## 1. 项目背景与目标

### 1.1 项目背景

本项目旨在开发一个 **基于微信小程序 + PyTorch 后端服务** 的视频处理系统。用户通过微信小程序录制并上传一段视频，后端服务器接收视频并进行处理（当前阶段为 Dummy 处理，后续逐步替换为真实模型与算法），处理完成后返回 **处理后的视频文件** 以及 **与视频相关的结构化数据**，供用户下载与查看。

### 1.2 项目目标

* 搭建一套完整的前后端视频处理流程（录制 → 上传 → 处理 → 下载）
* 后端使用 PyTorch 框架，先实现 Dummy 版本，保证接口与流程稳定
* 为后续引入真实模型（如视频分析、动作识别、AI 特效等）预留扩展空间
* 支持 Claude Code 进行代码生成、重构与持续迭代

### 1.3 项目阶段说明

* **Phase 1（当前）**：Dummy 后端逻辑，视频不做或仅做简单处理
* **Phase 2（未来）**：接入真实 PyTorch 模型与视频处理算法

---

## 2. 用户角色与使用场景

### 2.1 用户角色

* 普通用户：通过微信小程序录制视频并查看处理结果
* 开发者（内部）：维护前后端、模型与系统架构

### 2.2 使用场景

1. 用户打开微信小程序
2. 用户录制一段视频（或选择本地视频）
3. 用户提交视频进行处理
4. 后端接收视频并执行处理任务
5. 用户在小程序中查看处理进度
6. 处理完成后：

   * 用户在线观看处理后的视频
   * 用户下载视频文件
   * 用户下载与视频相关的数据文件（如 JSON）

---

## 3. 系统整体架构

### 3.1 架构概览

* **前端**：微信小程序
* **后端**：Python + PyTorch + Web 框架（FastAPI / Flask）
* **存储**：本地文件系统（Phase 1），后续可扩展至云存储
* **通信方式**：HTTP / HTTPS（REST API）

### 3.2 架构流程

1. 小程序调用视频录制接口
2. 视频通过 HTTP 上传至后端
3. 后端保存原始视频文件
4. 后端调用 PyTorch Dummy 处理模块
5. 生成：

   * 处理后的视频文件
   * 视频相关数据文件（JSON / CSV）
6. 后端返回处理状态与资源访问地址
7. 小程序下载并展示结果

---

## 4. 前端需求（微信小程序）

### 4.1 功能需求

#### 4.1.1 视频录制

* 支持使用微信原生 API 录制视频
* 支持设置最大录制时长（如 10–60 秒）
* 支持基础校验（时长、格式、大小）

#### 4.1.2 视频上传

* 支持将视频文件上传至后端服务器
* 显示上传进度
* 上传失败可重试

#### 4.1.3 处理状态展示

* 显示“处理中”状态
* 支持轮询或定时刷新处理结果

#### 4.1.4 结果展示与下载

* 视频在线播放（处理后视频）
* 视频文件下载
* 视频相关数据下载（如 JSON 文件）

### 4.2 非功能需求

* UI 简洁，操作路径清晰
* 网络异常有明确提示
* 兼容主流微信版本

---

## 5. 后端需求（PyTorch Dummy 服务）

### 5.1 技术选型

* 编程语言：Python 3.9+
* 深度学习框架：PyTorch
* Web 框架：FastAPI（推荐）或 Flask
* 视频处理：OpenCV / FFmpeg（可选）

### 5.2 核心功能模块

#### 5.2.1 视频接收模块

* 接收前端上传的视频文件
* 校验文件格式与大小
* 保存原始视频至指定目录

#### 5.2.2 Dummy 视频处理模块

* 使用 PyTorch 编写 Dummy 模型或占位逻辑
* 示例 Dummy 行为：

  * 原视频直接复制
  * 或添加水印 / 改变分辨率 / 抽帧
* 保证接口与未来真实模型一致

#### 5.2.3 数据生成模块

* 针对每个视频生成一份结构化数据文件
* 示例字段：

  * video_id
  * 原视频时长
  * 帧数（可 Dummy）
  * 处理时间
  * 预留模型输出字段

#### 5.2.4 结果管理模块

* 管理原始视频、处理后视频与数据文件
* 提供统一访问路径

### 5.3 API 接口设计（示例）

#### 5.3.1 上传视频

* `POST /api/video/upload`
* 请求参数：video(file)
* 返回：video_id, status

#### 5.3.2 查询处理状态

* `GET /api/video/status/{video_id}`
* 返回：processing / done / failed

#### 5.3.3 获取处理后视频

* `GET /api/video/result/{video_id}`

#### 5.3.4 获取视频数据文件

* `GET /api/video/data/{video_id}`

---

## 6. 数据设计

### 6.1 文件结构示例

* data/

  * raw_videos/
  * processed_videos/
  * metadata/

### 6.2 数据文件格式（JSON 示例）

* video_id: string
* duration: float
* frame_count: int
* processing_time: float
* model_version: string
* extra_fields: object

---

## 7. 安全与权限（Phase 1 简化）

* 暂不引入用户登录体系
* 使用 video_id 作为资源访问标识
* 后续可扩展：

  * 用户鉴权
  * 视频访问权限控制

---

## 8. Phase 2：AI驱动的高尔夫挥杆物理分析系统

### 8.1 Phase 2 目标

将项目升级为 **AI视频理解 + MuJoCo物理仿真 + 强化学习优化** 的综合系统，为用户提供科学的挥杆改进建议。

**三大核心价值**：
* **AI技术**：深度学习驱动的3D姿态估计、动作识别、物体追踪
* **机器人仿真**：MuJoCo高精度物理仿真与动力学分析
* **用户实用性**：可落地的高尔夫训练辅助工具

### 8.2 技术架构

#### 8.2.1 AI视频分析模块（PyTorch）

**功能**：
* 3D人体姿态估计（MediaPipe）
* 球杆轨迹追踪（YOLOv8 + ByteTrack）
* 挥杆阶段识别（Temporal Segmentation）
* 击球瞬间检测

**输出**：
* 17个关节的3D坐标序列（30fps）
* 球杆轨迹点云
* 挥杆阶段标注（Address → Backswing → Downswing → Impact → Follow-through）

**技术亮点**：
* 单目视频重建3D姿态
* 多任务学习网络
* 时序动作识别

#### 8.2.2 MuJoCo物理仿真模块

**功能**：
* 定制人体模型（26自由度 MJCF 模型）
* 轨迹驱动仿真（mocap控制）
* 逆向动力学计算（关节力矩）
* 接触力分析（地面反作用力）
* 能量传递链分析（Kinetic Chain）

**核心分析指标**：
* **杆头速度曲线**：击球瞬间速度、加速度峰值
* **关节力矩分析**：各关节力矩时序、峰值位置
* **能量效率评分**：下肢→躯干→手臂→球杆的能量传递效率
* **平衡稳定性**：重心轨迹、压力中心（COP）分析
* **地面反作用力**：左右脚蹬地力、X-Factor（肩髋分离角）
* **击球参数预测**：杆面角度、攻角、球飞行轨迹

**技术亮点**：
* 自定义 MJCF 人体+球杆模型
* mj_inverse 逆向动力学
* 接触力学与约束分析
* 物理合理性验证

#### 8.2.3 强化学习优化模块（可选高级功能）

**功能**：
* 在 MuJoCo 环境中训练 PPO/SAC 策略
* 学习最优挥杆轨迹
* 生成个性化改进建议
* 对比分析（用户 vs RL最优策略）

**技术亮点**：
* 自定义 Gymnasium 环境
* 多目标奖励函数设计
* Sim-to-Real 技术应用

### 8.3 后端实现

#### 8.3.1 新增依赖

```python
# requirements_phase2.txt
mujoco>=3.0.0
mediapipe>=0.10.21
ultralytics>=8.0.0  # YOLOv8
gymnasium>=0.29.0
stable-baselines3>=2.0.0
```

#### 8.3.2 目录结构扩展

```
backend/
├── app/
│   ├── models/
│   │   ├── pose_estimator.py      # 3D姿态估计
│   │   ├── video_analyzer.py      # 视频分析管道
│   │   ├── mujoco_simulator.py    # MuJoCo仿真器
│   │   ├── physics_analyzer.py    # 物理指标计算
│   │   └── rl_optimizer.py        # RL优化（可选）
│   ├── services/
│   │   └── golf_analysis_service.py
│   └── ...
├── assets/
│   ├── mjcf/
│   │   └── humanoid_golf.xml      # 人体+球杆模型
│   ├── rl_models/
│   │   └── golf_coach_ppo.zip     # 预训练RL模型
│   └── checkpoints/
│       └── pose_estimator.pth     # 姿态估计权重
└── ...
```

#### 8.3.3 新增 API 端点

```
POST /api/video/analyze/{video_id}
  - 触发完整分析流程
  - 返回：analysis_id

GET /api/analysis/status/{analysis_id}
  - 查询分析进度
  - 返回：progress, current_stage

GET /api/analysis/result/{analysis_id}
  - 获取完整分析结果
  - 返回：physics_data, suggestions, simulation_url

GET /api/analysis/visualization/{analysis_id}
  - 下载可视化资源
  - 返回：annotated_video, simulation_video, charts
```

### 8.4 前端展示（微信小程序）

#### 8.4.1 新增页面

* **分析结果页**：
  * 标注视频播放（骨骼点 + 球杆轨迹）
  * MuJoCo 仿真动画（3D可视化）
  * 物理指标仪表盘
  * 改进建议列表
  * 对比动画（用户 vs 优化后）

#### 8.4.2 数据可视化

* 杆头速度曲线图（ECharts）
* 关节力矩热力图
* 能量传递流程图
* 雷达图（综合评分）

### 8.5 处理流程

```
用户上传视频
    ↓
[阶段1] AI姿态估计（30s）
    → 提取3D关节轨迹
    ↓
[阶段2] MuJoCo仿真重建（20s）
    → 计算物理指标
    ↓
[阶段3] 物理分析（10s）
    → 生成评分和建议
    ↓
[阶段4] 可视化渲染（15s）
    → 生成标注视频和仿真动画
    ↓
返回完整报告
```

**总耗时**：约75秒（可通过异步队列优化）

### 8.6 技术挑战与解决方案

| 挑战 | 解决方案 |
|------|---------|
| 单目视频深度估计不准 | 使用预训练的VideoPose3D，结合人体先验约束 |
| MuJoCo轨迹驱动抖动 | 对AI输出轨迹进行平滑滤波（Savitzky-Golay） |
| 实时性要求高 | 使用GPU加速，异步任务队列（Celery） |
| 模型文件过大 | 模型量化，云端存储 |

### 8.7 评估指标

**技术指标**：
* 姿态估计精度：MPJPE < 30mm
* 仿真稳定性：无关节穿透、无非物理运动
* 端到端延迟：< 90秒

**用户价值指标**：
* 分析准确性：与专业教练评估一致性 > 80%
* 建议可操作性：用户采纳率 > 60%
* 用户满意度：评分 > 4.5/5.0

### 8.9 实施计划

**Phase 2A（核心功能）**：
* 3D姿态估计
* MuJoCo仿真重建
* 基础物理指标分析
* 可视化渲染

**Phase 2B（高级功能）**：
* 强化学习优化
* 个性化建议引擎
* 专业选手数据对比
* 训练计划生成

### 8.10 成功标准（Phase 2）

* ✅ 3D姿态估计误差 < 30mm
* ✅ MuJoCo仿真能稳定重现用户动作
* ✅ 物理指标计算准确且有意义
* ✅ 前端能流畅展示分析结果
* ✅ 端到端处理时间 < 2分钟
* ✅ 用户能理解并应用改进建议

---

## 9. 通用可扩展性规划

* 支持异步任务队列（Celery + Redis）
* 支持云存储（OSS / S3）
* 支持批量视频处理
* 多种运动场景扩展（网球、棒球等）
* 用户登录与数据管理

---

## 10. Claude Code 使用说明（开发约束）

* 本项目代码需结构清晰，模块解耦
* Dummy 逻辑需明确标注，便于后续替换
* API 接口需保持稳定，避免破坏前端
* 优先生成可运行、可测试的最小版本（MVP）

---

## 11. 成功标准（Phase 1）

* 微信小程序可成功录制并上传视频
* 后端可接收并完成 Dummy 处理
* 前端可成功下载并播放处理后视频
* 前端可下载对应的数据文件
* 系统整体流程稳定、可扩展

---

**文档版本**：v2.0
**状态**：Phase 1 已实现 / Phase 2 规划中
**核心技术**：微信小程序 + PyTorch + MuJoCo
**用途**：Claude Code 项目开发输入文档
